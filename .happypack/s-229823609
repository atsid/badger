'use strict';

var React = require('react');

// Components
var mui = require('material-ui');
var AppBar = mui.AppBar;
var LeftNav = mui.LeftNav;
var FlatButton = mui.FlatButton;
var Router = require('react-router');

var Skeleton = React.createClass({
  displayName: 'Skeleton',

  propTypes: {
    children: React.PropTypes.node
  },

  contextTypes: {
    history: Router.PropTypes.history.isRequired,
    stores: React.PropTypes.object.isRequired
  },

  getInitialState: function getInitialState() {
    return { loading: true, user: null };
  },
  componentDidMount: function componentDidMount() {
    this.getStateFromStore();
  },
  onLeftNavToggle: function onLeftNavToggle() {
    return this.refs.leftNav.toggle();
  },
  onLeftNavChange: function onLeftNavChange(e, key, payload) {
    // Do DOM Diff refresh
    this.context.history.pushState(null, payload.route);
  },
  getStateFromStore: function getStateFromStore() {
    var _this = this;

    this.state = { projects: [], loading: true };
    return this.context.stores.users.getCurrentUser().then(function (user) {
      return _this.setState({ user: user, loading: false });
    }).catch(function () {
      _this.setState({ loading: false });
    });
  },
  render: function render() {
    var menuItems = [{ route: '/', text: 'Home' }, { route: '/mine', text: 'My Projects', disabled: !this.state.user }];

    if (this.state.user) {
      menuItems.push({ route: '/logout', text: 'Logout' });
    } else {
      menuItems.push({ route: '/login', text: 'Login' });
    }

    var appBarRightLabel = this.state.user ? this.state.user.name : 'Login';
    return React.createElement(
      'div',
      null,
      React.createElement(LeftNav, {
        ref: 'leftNav',
        menuItems: menuItems,
        docked: false,
        onChange: this.onLeftNavChange }),
      React.createElement(
        'header',
        null,
        React.createElement(AppBar, {
          title: 'Badger',
          onLeftIconButtonTouchTap: this.onLeftNavToggle,
          iconElementRight: React.createElement(FlatButton, { label: appBarRightLabel }) })
      ),
      React.createElement(
        'section',
        { className: 'content' },
        this.props.children
      )
    );
  }
});

module.exports = Skeleton;